---
import type { GetStaticPaths, Page } from "astro"
import { getCollection } from "astro:content"
import BlogCategoryPage from "@/pages/blog/[category]/[page].astro"

export const getStaticPaths = (async ({ paginate }) => {
	const siteCategories = Object.fromEntries(
		(await getCollection("categories")).map((category) => [
			category.id,
			category,
		]),
	)

	const postCollection = await getCollection(
		"posts",
		(post) => post.id.includes("/") && post.id.startsWith("en"),
	)

	const categories = [
		...new Set(
			postCollection
				.map((post) => post.data.category)
				.filter((category): category is string => !!category),
		),
	]

	const posts = postCollection.toSorted(
		(a, b) => b.data.date.getTime() - a.data.date.getTime(),
	)

	return categories.flatMap((category) =>
		paginate(
			posts.filter(
				(post) => post.data.category === siteCategories[category].id,
			),
			{
				params: { category: siteCategories[category].data.slug },
				props: { category: siteCategories[category] },
				pageSize: 7,
			},
		),
	)
}) satisfies GetStaticPaths

type Category = Awaited<ReturnType<typeof getCollection<"categories">>>[number]
type Post = Awaited<ReturnType<typeof getCollection<"posts">>>[number]

interface Props {
	category: Category
	page: Page<Post>
}

const { category, page } = Astro.props

const categories = [
	...new Set(
		(
			await getCollection(
				"posts",
				(post) => post.id.includes("/") && post.id.startsWith("en"),
			)
		)
			.map((post) => post.data.category)
			.filter((category): category is string => !!category),
	),
]
---

<BlogCategoryPage category={category} categories={categories} page={page} />
